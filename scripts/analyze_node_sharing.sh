#!/bin/bash
# SMT Node Sharing Analysis - æ·±åº¦åˆ†æå·¥å…·
# åŸºäºæœ€æ–° Pruner å’Œ StateDB å®ç°

set -e

ROOCH_DB="${ROOCH_DB:-$HOME/.rooch/local/roochdb/store}"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           SMT Node Sharing & Pruning Effectiveness Analysis          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Database: $ROOCH_DB"
echo ""

# ============================================================================
# Part 1: æ•°æ®åº“å½“å‰çŠ¶æ€
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Part 1: Database Current State"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

rooch db rocksdb-stats --db-path "$ROOCH_DB" > /tmp/rooch_stats.txt 2>&1 || {
    echo "âŒ Error: Failed to get database stats"
    echo "   Please ensure 'rooch' is in PATH and database exists"
    exit 1
}

# æå–å…³é”®æŒ‡æ ‡
STATE_NODE_SIZE=$(grep -A 10 "state_node" /tmp/rooch_stats.txt | grep "Total SST" | awk '{print $3}')
STATE_NODE_LIVE=$(grep -A 10 "state_node" /tmp/rooch_stats.txt | grep "Live SST" | awk '{print $3}')
STATE_NODE_ESTIMATE=$(grep -A 10 "state_node" /tmp/rooch_stats.txt | grep "Est. live data" | awk '{print $4}')
PENDING_COMPACT=$(grep -A 10 "state_node" /tmp/rooch_stats.txt | grep "Pending compact" | awk '{print $3}')

echo "state_node CF (ä¸»è¦ SMT èŠ‚ç‚¹å­˜å‚¨):"
echo "  Total SST size:      ${STATE_NODE_SIZE:-N/A} GB"
echo "  Live SST size:       ${STATE_NODE_LIVE:-N/A} GB"
echo "  Est. live data:      ${STATE_NODE_ESTIMATE:-N/A} GB"
echo "  Pending compaction:  ${PENDING_COMPACT:-N/A} GB"
echo ""

# æ˜¾ç¤ºå®Œæ•´ç»Ÿè®¡
cat /tmp/rooch_stats.txt
echo ""

# ============================================================================
# Part 2: Pruner å·¥ä½œåŸç†è¯´æ˜
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš™ï¸  Part 2: How Pruner Works (Current Implementation)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
cat << 'EOF'
Pruner ä¸‰é˜¶æ®µå·¥ä½œæµç¨‹:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: BuildReach (æ„å»ºå¯è¾¾é›†)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è·å–å½“å‰æœ€æ–° state_root (startup_info)                           â”‚
â”‚ 2. ä»è¿™ä¸ª SINGLE root å¼€å§‹ DFS éå†æ‰€æœ‰å¯è¾¾èŠ‚ç‚¹                     â”‚
â”‚ 3. å°†å¯è¾¾èŠ‚ç‚¹å“ˆå¸Œå­˜å…¥ BloomFilter (å†…å­˜)                            â”‚
â”‚ 4. ä¿å­˜ bloom åˆ° cf_prune_meta_bloom                                â”‚
â”‚ 5. è½¬å…¥ SweepExpired é˜¶æ®µ                                           â”‚
â”‚                                                                      â”‚
â”‚ âš ï¸  å…³é”®: åªä¿ç•™1ä¸ª live root,ä¸æ˜¯å¤šå¤©çª—å£!                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: SweepExpired (æ¸…ç†è¿‡æœŸèŠ‚ç‚¹)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä» latest_order-30000 åˆ° 0 é€†åºæ‰«æå†å² state_change_set         â”‚
â”‚ 2. å¯¹æ¯ä¸ªå†å² root, DFS éå†å…¶å­èŠ‚ç‚¹                                â”‚
â”‚ 3. æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åœ¨ bloom (å¯è¾¾é›†) ä¸­:                                â”‚
â”‚    - åœ¨ bloom ä¸­ â†’ ä»è¢«å½“å‰ root å¼•ç”¨ â†’ è·³è¿‡                        â”‚
â”‚    - ä¸åœ¨ bloom ä¸­ â†’ å­¤ç«‹èŠ‚ç‚¹ â†’ æ ‡è®°åˆ é™¤                            â”‚
â”‚ 4. æ‰¹é‡åˆ é™¤èŠ‚ç‚¹ (æ¯ 10000 ä¸ªèŠ‚ç‚¹ä¸€æ‰¹)                               â”‚
â”‚ 5. æ¯å¤„ç† 200 ä¸ª root åšä¸€æ¬¡ aggressive compaction                  â”‚
â”‚ 6. è½¬å…¥ Incremental é˜¶æ®µ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: Incremental (å¢é‡æ¸…ç† - å½“å‰è¢«ç¦ç”¨)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç†è®ºè®¾è®¡:                                                            â”‚
â”‚ - ä½¿ç”¨ cf_smt_stale ç´¢å¼•è·Ÿè¸ªè¿‡æœŸèŠ‚ç‚¹                                 â”‚
â”‚ - ä½¿ç”¨ cf_node_refcount ç»´æŠ¤å¼•ç”¨è®¡æ•°                                 â”‚
â”‚ - å½“ refcount=0 æ—¶ç›´æ¥åˆ é™¤,æ— éœ€ DFS                                  â”‚
â”‚                                                                      â”‚
â”‚ å½“å‰çŠ¶æ€: âŒ è¢«ç¦ç”¨ ("do Nothing")                                   â”‚
â”‚ åŸå› : cf_smt_stale/node_refcount ä»…å¯¹æ–°æ•°æ®æœ‰æ•ˆ,å†å²æ•°æ®æ— æ­¤ä¿¡æ¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EOF

# ============================================================================
# Part 3: èŠ‚ç‚¹å…±äº«ç‡åˆ†æ
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¬ Part 3: Node Sharing Rate Analysis"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
cat << 'EOF'
ä¸ºä»€ä¹ˆæ¸…ç†æ•ˆæœå¯èƒ½ä¸æ˜æ˜¾? SMT Copy-on-Write çš„èŠ‚ç‚¹å…±äº«ç‰¹æ€§:

ç¤ºä¾‹: ä¸€ä¸ªåŒ…å« 100ä¸‡æ¡è®°å½•çš„ AccountTable (~150ä¸‡ SMT èŠ‚ç‚¹)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—¶é—´ç‚¹    â”‚ ä¿®æ”¹é‡      â”‚ æ–°å¢èŠ‚ç‚¹  â”‚ å…±äº«èŠ‚ç‚¹       â”‚ å…±äº«ç‡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Day 1     â”‚ å…¨æ–°åˆ›å»º    â”‚ 1,500,000 â”‚ 0              â”‚ 0%     â”‚
â”‚ Day 2     â”‚ 1000 æ›´æ–°   â”‚ ~1,500    â”‚ 1,498,500      â”‚ 99.9%  â”‚
â”‚ Day 7     â”‚ ç´¯è®¡ 7kæ›´æ–° â”‚ ~10,500   â”‚ 1,489,500      â”‚ 99.3%  â”‚
â”‚ Day 30    â”‚ ç´¯è®¡ 30kæ›´æ–°â”‚ ~45,000   â”‚ 1,455,000      â”‚ 97%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” Pruner æ¸…ç† Day 1 æ•°æ®æ—¶çš„å®é™…æƒ…å†µ:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Day 1 Root                                              â”‚
  â”‚   â”œâ”€ 1,500,000 nodes                                    â”‚
  â”‚   â”‚                                                      â”‚
  â”‚   â”œâ”€ 1,498,500 nodes (99.9%) âœ… ä»è¢« Current Root å¼•ç”¨  â”‚
  â”‚   â”‚                           â†’ åœ¨ Bloom ä¸­             â”‚
  â”‚   â”‚                           â†’ ä¸èƒ½åˆ é™¤ (æ­£ç¡®!)        â”‚
  â”‚   â”‚                                                      â”‚
  â”‚   â””â”€ 1,500 nodes (0.1%) âŒ å·²è¢«æ–°ç‰ˆæœ¬æ›¿æ¢              â”‚
  â”‚                          â†’ ä¸åœ¨ Bloom ä¸­               â”‚
  â”‚                          â†’ å¯ä»¥åˆ é™¤                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®º: å³ä½¿ Pruner æ­£ç¡®å·¥ä½œ,ä¹Ÿåªèƒ½åˆ é™¤çº¦ 0.1-3% çš„èŠ‚ç‚¹!

EOF

echo ""
echo "ğŸ’¡ å¦‚ä½•éªŒè¯èŠ‚ç‚¹å…±äº«ç‡?"
echo ""
echo "æ–¹æ³• 1: ä½¿ç”¨ delete-benchmark å·¥å…· (æ¨è)"
echo "----------------------------------------"
echo "  # 1. è®°å½•åˆ é™¤å‰çŠ¶æ€"
echo "  rooch db delete-benchmark snapshot --name before --db-path \"$ROOCH_DB\""
echo ""
echo "  # 2. è¿è¡Œ pruner æˆ–æ‰‹åŠ¨æ¸…ç†"
echo "  # (ç­‰å¾… pruner å®Œæˆä¸€ä¸ªå‘¨æœŸ,æˆ–æ‰‹åŠ¨è¿è¡Œæ¸…ç†å‘½ä»¤)"
echo ""
echo "  # 3. å¯¹æ¯”åˆ é™¤åçŠ¶æ€"
echo "  rooch db delete-benchmark compare --name before --db-path \"$ROOCH_DB\""
echo ""
echo "  é¢„æœŸç»“æœè§£è¯»:"
echo "  - å›æ”¶ < 5%:  èŠ‚ç‚¹å…±äº«ç‡æé«˜ (>95%),æ¸…ç†æ•ˆæœæœ‰é™æ˜¯æ­£å¸¸ç°è±¡"
echo "  - å›æ”¶ 5-15%: ä¸­ç­‰å…±äº«ç‡,æ¸…ç†æœ‰ä¸€å®šæ•ˆæœ"
echo "  - å›æ”¶ > 20%: å­˜åœ¨å¤§é‡å­¤ç«‹èŠ‚ç‚¹,æ¸…ç†æ•ˆæœåº”è¯¥å¾ˆæ˜æ˜¾"
echo ""

echo "æ–¹æ³• 2: æ£€æŸ¥ Pruner æ—¥å¿—"
echo "----------------------------------------"
echo "  æŸ¥çœ‹ Pruner è¿è¡Œæ—¥å¿—ä¸­çš„å…³é”®æŒ‡æ ‡:"
echo ""
echo "  grep 'Completed reachability build' <rooch.log>"
echo "  â†’ æ˜¾ç¤º 'scanned size' = å¯è¾¾èŠ‚ç‚¹æ•°"
echo ""
echo "  grep 'deleted.*nodes' <rooch.log>"
echo "  â†’ æ˜¾ç¤ºå®é™…åˆ é™¤çš„èŠ‚ç‚¹æ•°"
echo ""
echo "  èŠ‚ç‚¹å…±äº«ç‡ = (scanned_size / total_nodes) Ã— 100%"
echo ""

# ============================================================================
# Part 4: ç³»ç»Ÿè¡¨ vs ç”¨æˆ·æ•°æ®çš„å½±å“
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ—‚ï¸  Part 4: System Tables vs User Data"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
cat << 'EOF'
æ¸…ç†æ•ˆæœå—æ•°æ®ç±»å‹å½±å“:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®ç±»å‹          â”‚ å æ¯”  â”‚ æ›´æ–°é¢‘ç‡ â”‚ èŠ‚ç‚¹å¤ç”¨ç‡ â”‚ å¯æ¸…ç†ç‡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç³»ç»Ÿè¡¨            â”‚ 70-90%â”‚ æé«˜     â”‚ 99%+       â”‚ <1%      â”‚
â”‚ (AccountTable,    â”‚       â”‚ (æ¯ç§’)   â”‚            â”‚          â”‚
â”‚  ModuleStoreç­‰)   â”‚       â”‚          â”‚            â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·æ•°æ®          â”‚ 10-30%â”‚ ä¸­ç­‰     â”‚ 80-95%     â”‚ 5-20%    â”‚
â”‚ (è‡ªå®šä¹‰ Objects)  â”‚       â”‚          â”‚            â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·²åˆ é™¤ Objects    â”‚ 0-5%  â”‚ æ—        â”‚ 0%         â”‚ 100%     â”‚
â”‚ (å®Œå…¨ä¸å†å¼•ç”¨)    â”‚       â”‚          â”‚            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹è®¡ç®— (100 GB æ•°æ®åº“):
  
  ç³»ç»Ÿè¡¨:    80 GB Ã— 1% å¯æ¸…ç†    = 0.8 GB
  ç”¨æˆ·æ•°æ®:  18 GB Ã— 10% å¯æ¸…ç†   = 1.8 GB
  å·²åˆ é™¤:     2 GB Ã— 100% å¯æ¸…ç†  = 2.0 GB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»è®¡å¯å›æ”¶:                      4.6 GB (4.6%)

ç»“è®º: å³ä½¿ Pruner å®Œç¾å·¥ä½œ,ä¹Ÿåªèƒ½å›æ”¶ 4-6% çš„ç©ºé—´!

EOF

# ============================================================================
# Part 5: ä¼˜åŒ–å»ºè®®
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¡ Part 5: Optimization Recommendations"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
cat << 'EOF'
çŸ­æœŸä¼˜åŒ–:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. âœ… ç¡®ä¿ Pruner æ­£å¸¸è¿è¡Œ
   - æ£€æŸ¥æ—¥å¿—: grep "Pruner" <rooch.log>
   - éªŒè¯é˜¶æ®µè½¬æ¢: BuildReach â†’ SweepExpired â†’ Incremental

2. âœ… æ‰‹åŠ¨è§¦å‘ Compaction (å¦‚æœ Pruner åˆ é™¤äº†èŠ‚ç‚¹ä½†ç©ºé—´æœªé‡Šæ”¾)
   rooch db rocksdb-gc --db-path "$ROOCH_DB"

3. âš ï¸  è°ƒæ•´ Pruner æ‰«æèŒƒå›´ (è°¨æ…!)
   - å½“å‰: latest_order-30000 (å›ºå®šçª—å£)
   - å¯è°ƒæ•´ä¸ºæ›´å¤§èŒƒå›´ä»¥æ¸…ç†æ›´å¤šå†å²æ•°æ®
   - æ³¨æ„: ä¼šåˆ é™¤å†å²çŠ¶æ€,å½±å“å¯éªŒè¯æ€§

ä¸­æœŸä¼˜åŒ–:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
4. ğŸ”§ å¯ç”¨ Incremental é˜¶æ®µ (éœ€è¦ä»£ç ä¿®æ”¹)
   - å¯¹æ–°æ•°æ®ä½¿ç”¨ refcount æœºåˆ¶
   - é¿å…é‡å¤ DFS éå†

5. ğŸ“Š å®æ–½åˆ†å±‚å­˜å‚¨ç­–ç•¥
   - çƒ­æ•°æ® (æœ€æ–°):        å®Œæ•´ SMT
   - æ¸©æ•°æ® (30å¤©å†…):      å‹ç¼©å¿«ç…§
   - å†·æ•°æ® (>30å¤©):       å½’æ¡£/ä»… checkpoint

é•¿æœŸæ¶æ„æ”¹è¿›:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6. ğŸ—ï¸  å¼•å…¥ Copy-on-Write ä¼˜åŒ–
   - å…±äº«ä¸å˜å­æ ‘ (immutable subtree sharing)
   - å¼•ç”¨è®¡æ•°åœ¨å†™å…¥æ—¶ç»´æŠ¤

7. ğŸ“¦ è¡¨çº§è¿‡æœŸç­–ç•¥
   - å¯¹ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨è®¾ç½® TTL
   - è¿‡æœŸåæ•´æ£µå­æ ‘æ ‡è®°åˆ é™¤

8. ğŸ—œï¸  èŠ‚ç‚¹å‹ç¼©
   - å®šæœŸåˆå¹¶ç¨€ç–åˆ†æ”¯
   - å‹ç¼©é•¿æœŸä¸å˜çš„å­æ ‘

EOF

# ============================================================================
# Part 6: å½“å‰ç³»ç»Ÿè¯Šæ–­
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ©º Part 6: Current System Diagnosis"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "æ­£åœ¨æ£€æŸ¥ Pruner ç›¸å…³ CF çŠ¶æ€..."
echo ""

# æ£€æŸ¥ Pruner å…ƒæ•°æ® CF
for cf in "prune_meta_phase" "prune_meta_bloom" "reach_seen" "smt_stale_index" "node_refcount"; do
    SIZE=$(grep -A 10 "^--- $cf ---" /tmp/rooch_stats.txt 2>/dev/null | grep "Total SST" | awk '{print $3}' || echo "N/A")
    echo "  $cf: ${SIZE} GB"
done

echo ""
echo "ğŸ“‹ Quick Health Check:"
echo ""

# æ£€æŸ¥ pending compaction
if [ -n "$PENDING_COMPACT" ] && [ "$PENDING_COMPACT" != "0.00" ]; then
    echo "  âš ï¸  Pending compaction: ${PENDING_COMPACT} GB"
    echo "      â†’ å»ºè®®è¿è¡Œ: rooch db rocksdb-gc --db-path \"$ROOCH_DB\""
else
    echo "  âœ… No significant pending compaction"
fi

# æ£€æŸ¥ live vs total æ¯”ä¾‹
if [ -n "$STATE_NODE_SIZE" ] && [ -n "$STATE_NODE_LIVE" ]; then
    echo ""
    echo "  ğŸ“Š SST efficiency: ${STATE_NODE_LIVE}/${STATE_NODE_SIZE} GB"
    echo "      (Live/Total ratio indicates how much is potentially reclaimable)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Analysis Complete"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ä¸‹ä¸€æ­¥å»ºè®®:"
echo ""
echo "1. ä½¿ç”¨ delete-benchmark éªŒè¯æ¸…ç†æ•ˆæœ:"
echo "   rooch db delete-benchmark snapshot --name baseline --db-path \"$ROOCH_DB\""
echo ""
echo "2. ç­‰å¾…æˆ–æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ Pruner å‘¨æœŸ"
echo ""
echo "3. å¯¹æ¯”ç»“æœ:"
echo "   rooch db delete-benchmark compare --name baseline --db-path \"$ROOCH_DB\""
echo ""
echo "4. å¦‚æœæ¸…ç†æ•ˆæœ < 5%, è¿™æ˜¯ **æ­£å¸¸ç°è±¡**, ä¸æ˜¯ bug!"
echo "   åŸå› : SMT Copy-on-Write å¯¼è‡´çš„é«˜èŠ‚ç‚¹å…±äº«ç‡"
echo ""

# Cleanup
rm -f /tmp/rooch_stats.txt
