# `rooch payment-channel` CLI Command Design

This document outlines the design for a `rooch` subcommand to test and interact with the payment channel protocol.

## 1. Main Command

The primary command structure is:

`rooch payment-channel <subcommand> [options]`

## 2. Subcommands

Here are the detailed specifications for each subcommand.

---

### `init`

- **Purpose**: Initializes the testing environment by creating a Payment Hub for the sender and depositing a specified amount of tokens into it.
- **Command**: `rooch payment-channel init --sender <SENDER_ADDRESS> --amount <AMOUNT> [--coin-type <COIN_TYPE>]`
- **Parameters**:
  - `--sender`: The address of the payment sender.
  - `--amount`: The amount of tokens to deposit into the Payment Hub.
  - `--coin-type`: (Optional) The type of the coin, defaults to `0x3::gas_coin::RGas`.
- **Workflow**:
  1. Calls `payment_channel::deposit_to_hub_entry`. This function automatically creates the Payment Hub if it does not exist and deposits the specified tokens.

---

### `open`

- **Purpose**: Opens a payment channel between a sender and a receiver, and authorizes one or more sub-channels.
- **Command**: `rooch payment-channel open --sender <SENDER_ADDRESS> --receiver <RECEIVER_ADDRESS> --vm-id-fragments <VM_ID_FRAGMENTS> [--coin-type <COIN_TYPE>]`
- **Parameters**:
  - `--sender`: The address of the payment sender.
  - `--receiver`: The address of the payment receiver.
  - `--vm-id-fragments`: One or more DID Verification Method IDs (VM IDs) for the sub-channels, separated by commas (e.g., `"key-1,key-2"`).
  - `--coin-type`: (Optional) The type of the coin, defaults to `0x3::gas_coin::RGas`.
- **Workflow**:
  1. Calls `payment_channel::open_channel_with_multiple_sub_channels_entry` to open the channel and authorize sub-channels in a single transaction.
  2. Outputs the newly created channel object ID (`channel_id`).

---

### `create-rav`

- **Purpose**: Simulates an off-chain payment by generating a signed `SubRAV` (Sub-channel Receipt and Voucher). This command is executed off-chain to produce the necessary credentials for testing.
- **Command**: `rooch payment-channel create-rav --channel-id <CHANNEL_ID> --vm-id-fragment <VM_ID_FRAGMENT> --amount <AMOUNT> --nonce <NONCE>`
- **Parameters**:
  - `--channel-id`: The object ID of the payment channel.
  - `--vm-id-fragment`: The DID VM ID of the sub-channel used for signing.
  - `--amount`: The accumulated payment amount in this `SubRAV`.
  - `--nonce`: A sequence number that must be greater than the last confirmed `nonce` for this sub-channel on-chain.
- **Workflow**:
  1. Constructs the `SubRAV` struct based on the provided parameters.
  2. Signs the hash of the `SubRAV` using the private key associated with the `vm-id-fragment`.
  3. Outputs the serialized `SubRAV` data and the signature, which can be used by the `claim` or `close` commands.

---

### `claim`

- **Purpose**: Allows the receiver to claim funds from a channel using a `SubRAV` without closing the channel.
- **Command**: `rooch payment-channel claim --receiver <RECEIVER_ADDRESS> --channel-id <CHANNEL_ID> --rav <SERIALIZED_RAV> --signature <SIGNATURE>`
- **Parameters**:
  - `--receiver`: The address of the payment receiver (who signs the transaction).
  - `--channel-id`: The object ID of the payment channel.
  - `--rav`: The serialized `SubRAV` data generated by the `create-rav` command.
  - `--signature`: The corresponding signature.
- **Workflow**:
  1. Calls `payment_channel::claim_from_channel_entry`, submitting the voucher and signature.
  2. The contract verifies the signature and nonce, then transfers the incremental funds from the Payment Hub to the receiver.

---

### `close`

- **Purpose**: Allows the receiver to cooperatively close a channel and settle the final balances for all sub-channels.
- **Command**: `rooch payment-channel close --receiver <RECEIVER_ADDRESS> --channel-id <CHANNEL_ID> --proofs <SERIALIZED_PROOFS>`
- **Parameters**:
  - `--receiver`: The address of the payment receiver (who signs the transaction).
  - `--channel-id`: The object ID of the payment channel.
  - `--proofs`: A serialized `vector<CloseProof>` struct, containing the final `SubRAV` and signature for each sub-channel.
- **Workflow**:
  1. Calls `payment_channel::close_channel_entry`.
  2. The contract verifies all proofs, settles the final payments, and marks the channel status as `Closed`.

---

### `cancel`

- **Purpose**: Allows the sender to unilaterally initiate the channel cancellation process, which starts a challenge period.
- **Command**: `rooch payment-channel cancel --sender <SENDER_ADDRESS> --channel-id <CHANNEL_ID>`
- **Parameters**:
  - `--sender`: The address of the payment sender.
  - `--channel-id`: The object ID of the payment channel.
- **Workflow**:
  1. Calls `payment_channel::initiate_cancellation_entry`.

---

### `dispute`

- **Purpose**: Allows the receiver to dispute a cancellation by submitting a more recent `SubRAV` during the challenge period.
- **Command**: `rooch payment-channel dispute --receiver <RECEIVER_ADDRESS> --channel-id <CHANNEL_ID> --rav <SERIALIZED_RAV> --signature <SIGNATURE>`
- **Parameters**:
  - `--receiver`: The address of the payment receiver.
  - `--channel-id`: The object ID of the payment channel.
  - `--rav`: The serialized `SubRAV` data.
  - `--signature`: The corresponding signature.
- **Workflow**:
  1. Calls `payment_channel::dispute_cancellation_entry`.

---

### `finalize-cancellation`

- **Purpose**: After the challenge period ends, anyone can call this function to finalize the channel's cancellation and settle the funds.
- **Command**: `rooch payment-channel finalize-cancellation --channel-id <CHANNEL_ID>`
- **Parameters**:
  - `--channel-id`: The object ID of the payment channel.
- **Workflow**:
  1. Calls `payment_channel::finalize_cancellation_entry`.

---

### `query`

- **Purpose**: Queries the state of a Payment Hub or a payment channel.
- **Commands**:
  - `rooch payment-channel query hub --owner <OWNER_ADDRESS>`
  - `rooch payment-channel query channel --channel-id <CHANNEL_ID>`
- **Parameters**:
  - `--owner`: The address of the Payment Hub's owner.
  - `--channel-id`: The object ID of the payment channel.
- **Workflow**:
  1. Calls the appropriate view functions (e.g., `get_payment_hub_id`, `get_channel_info`) and displays the results.
