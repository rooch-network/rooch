# `rooch payment-channel` CLI Command Design

This document outlines the design for a `rooch` subcommand to test and interact with the payment channel protocol.

## 1. Main Command

The primary command structure is:

`rooch payment-channel <subcommand> [options]`

## 2. Subcommands

Here are the detailed specifications for each subcommand.

---

### `init`

- **Purpose**: Initializes the testing environment by creating a Payment Hub for the sender and depositing a specified amount of tokens into it.
- **Command**: `rooch payment-channel init --sender <SENDER_ADDRESS> --amount <AMOUNT> [--coin-type <COIN_TYPE>]`
- **Parameters**:
  - `--sender`: The address of the payment sender.
  - `--amount`: The amount of tokens to deposit into the Payment Hub.
  - `--coin-type`: (Optional) The type of the coin, defaults to `0x3::gas_coin::RGas`.
- **Workflow**:
  1. Calls `payment_channel::deposit_to_hub_entry`. This function automatically creates the Payment Hub if it does not exist and deposits the specified tokens.

---

### `open`

- **Purpose**: Opens a payment channel between a sender and a receiver, and authorizes one or more sub-channels.
- **Command**: `rooch payment-channel open --sender <SENDER_ADDRESS> --receiver <RECEIVER_ADDRESS> --vm-id-fragments <VM_ID_FRAGMENTS> [--coin-type <COIN_TYPE>]`
- **Parameters**:
  - `--sender`: The address of the payment sender.
  - `--receiver`: The address of the payment receiver.
  - `--vm-id-fragments`: One or more DID Verification Method IDs (VM IDs) for the sub-channels, separated by commas (e.g., `"key-1,key-2"`).
  - `--coin-type`: (Optional) The type of the coin, defaults to `0x3::gas_coin::RGas`.
- **Workflow**:
  1. Calls `payment_channel::open_channel_with_multiple_sub_channels_entry` to open the channel and authorize sub-channels in a single transaction.
  2. Outputs the newly created channel object ID (`channel_id`).

---

### `create-rav`

- **Purpose**: Simulates an off-chain payment by generating a signed `SubRAV` (Sub-channel Receipt and Voucher). This command is executed off-chain to produce the necessary credentials for testing.
- **Command**: `rooch payment-channel create-rav --channel-id <CHANNEL_ID> --vm-id-fragment <VM_ID_FRAGMENT> --amount <AMOUNT> --nonce <NONCE>`
- **Parameters**:
  - `--channel-id`: The object ID of the payment channel.
  - `--vm-id-fragment`: The DID VM ID of the sub-channel used for signing.
  - `--amount`: The accumulated payment amount in this `SubRAV`.
  - `--nonce`: A sequence number that must be greater than the last confirmed `nonce` for this sub-channel on-chain.
- **Workflow**:
  1. Constructs the `SubRAV` struct based on the provided parameters.
  2. Signs the hash of the `SubRAV` using the private key associated with the `vm-id-fragment`.
  3. Outputs the serialized `SubRAV` data and the signature, which can be used by the `claim` or `close` commands.

---

### `claim`

- **Purpose**: Allows the receiver to claim funds from a channel using a `SubRAV` without closing the channel.
- **Command**: `rooch payment-channel claim --receiver <RECEIVER_ADDRESS> --channel-id <CHANNEL_ID> --rav <SERIALIZED_RAV> --signature <SIGNATURE>`
- **Parameters**:
  - `--receiver`: The address of the payment receiver (who signs the transaction).
  - `--channel-id`: The object ID of the payment channel.
  - `--rav`: The serialized `SubRAV` data generated by the `create-rav` command.
  - `--signature`: The corresponding signature.
- **Workflow**:
  1. Calls `payment_channel::claim_from_channel_entry`, submitting the voucher and signature.
  2. The contract verifies the signature and nonce, then transfers the incremental funds from the Payment Hub to the receiver.

---

### `close`

- **Purpose**: Allows the receiver to cooperatively close a channel and settle the final balances for all sub-channels.
- **Command**: `rooch payment-channel close --receiver <RECEIVER_ADDRESS> --channel-id <CHANNEL_ID> --proofs <SERIALIZED_PROOFS>`
- **Parameters**:
  - `--receiver`: The address of the payment receiver (who signs the transaction).
  - `--channel-id`: The object ID of the payment channel.
  - `--proofs`: A serialized `vector<CloseProof>` struct, containing the final `SubRAV` and signature for each sub-channel.
- **Workflow**:
  1. Calls `payment_channel::close_channel_entry`.
  2. The contract verifies all proofs, settles the final payments, and marks the channel status as `Closed`.

---

### `cancel`

- **Purpose**: Allows the sender to unilaterally initiate the channel cancellation process, which starts a challenge period.
- **Command**: `rooch payment-channel cancel --sender <SENDER_ADDRESS> --channel-id <CHANNEL_ID>`
- **Parameters**:
  - `--sender`: The address of the payment sender.
  - `--channel-id`: The object ID of the payment channel.
- **Workflow**:
  1. Calls `payment_channel::initiate_cancellation_entry`.

---

### `dispute`

- **Purpose**: Allows the receiver to dispute a cancellation by submitting a more recent `SubRAV` during the challenge period.
- **Command**: `rooch payment-channel dispute --receiver <RECEIVER_ADDRESS> --channel-id <CHANNEL_ID> --rav <SERIALIZED_RAV> --signature <SIGNATURE>`
- **Parameters**:
  - `--receiver`: The address of the payment receiver.
  - `--channel-id`: The object ID of the payment channel.
  - `--rav`: The serialized `SubRAV` data.
  - `--signature`: The corresponding signature.
- **Workflow**:
  1. Calls `payment_channel::dispute_cancellation_entry`.

---

### `finalize-cancellation`

- **Purpose**: After the challenge period ends, anyone can call this function to finalize the channel's cancellation and settle the funds.
- **Command**: `rooch payment-channel finalize-cancellation --channel-id <CHANNEL_ID>`
- **Parameters**:
  - `--channel-id`: The object ID of the payment channel.
- **Workflow**:
  1. Calls `payment_channel::finalize_cancellation_entry`.

---

### `query`

- **Purpose**: Queries the state of a Payment Hub or a payment channel.
- **Commands**:
  - `rooch payment-channel query hub --owner <OWNER_ADDRESS>`
  - `rooch payment-channel query channel --channel-id <CHANNEL_ID>`
- **Parameters**:
  - `--owner`: The address of the Payment Hub's owner.
  - `--channel-id`: The object ID of the payment channel.
- **Workflow**:
  1. Calls the appropriate view functions (e.g., `get_payment_hub_id`, `get_channel_info`) and displays the results.

#### Query Implementation Plan  
*(v3 – Off-chain Aggregation via `listFieldStates`)*

> 更新点：
> 1. 利用现有 RPC `listFieldStates`（而不是自定义 list_object_field_keys）遍历 object / table fields。
> 2. 重新整理 CLI `query` 子命令，只保留最核心且易用的几个。其余信息可以用 flags 控制。如下设计替换 v2 方案。

---

#### 1. RPC 侧能力复用

* **字段遍历**：`rooch.listFieldStates(object_id, cursor, limit, option)` 已能一次返回 `(key, value)` BCS bytes 列表，支持游标翻页。
* **表遍历**：`Table` 本质也是 `Object`（其 `handle` 为 ObjectID），因此同样使用 `listFieldStates(handle, ..)` 即可列出所有 `key → value`。
* **无需新增 RPC 接口**，仅在 CLI 端循环调用即可。

---

#### 2. CLI 子命令（最终稿）

```
rooch payment-channel query hub     --owner <ADDRESS> [--page-size <N>]
rooch payment-channel query channel --channel-id <OBJECT_ID> [--list-sub-channels] [--page-size <N>] [--vm-id <FRAGMENT>]
```

说明：
* `hub`  —— 输出 PaymentHub 的 `balances` 和 `active_channels` 信息。
* `channel` —— 始终输出基本信息（sender/receiver/status/coin_type/payment_hub_id/cancellation_info）。
  * `--list-sub-channels`  ⇒ 列出全部 sub-channels（分页）。
  * `--vm-id <FRAGMENT>`  ⇒ 仅查询指定 sub-channel 状态。
* `--page-size` 控制 `listFieldStates` 每次拉取数量，默认 100。

（如需查询更细粒度信息 —— 例如 cancellation details、active channel count —— 均可由上述输出字段直接获得，无需额外命令。）

---

#### 3. CLI 实现细节 (`crates/rooch/src/commands/payment_channel/commands/query.rs`)

1. **对象定位**
   * Hub ObjectID：完全在 **Rust 端** 计算。算法等同于 Move 的 `object::account_named_object_id<PaymentHub>(owner)`（即 *Account-Named ObjectID*）。无需额外 RPC。  
      → 在 `rooch` CLI 侧已有 `ObjectID::account_named_for::<PaymentHub>(owner)`（若缺失，则补充一个 util）。
   * Channel ObjectID：若用户只传 `channel-id` 就直接用；若未来需要通过 sender/receiver 计算，可调用 `payment_channel::calc_channel_object_id<CoinType>`。

2. **核心步骤（Hub 查询）**
   ```rust
   // 1. 直接计算 hub_id = account_named_object_id::<PaymentHub>(owner)
   // 2. get_object_states([hub_id])  → 反序列化 PaymentHub
   // 3. balances: listFieldStates(hub.multi_coin_store, ..) 每条 value 反序列化为 Balance
   // 4. active_channels: listFieldStates(hub.active_channels, ..) → (coin_type, count)
   ```

3. **核心步骤（Channel 查询）**
   ```rust
   // 1. get_object_states([channel_id]) → PaymentChannel
   // 2. 如 --list-sub-channels:
   //    listFieldStates(channel.sub_channels, ..) → (fragment, SubChannel)
   // 3. 如 --vm-id:   listFieldStates(channel.sub_channels, Some(fragment_key), 1)
   ```

4. **分页处理**：循环调用 `listFieldStates` 直到 `next_cursor == None` 或记录数达到用户期望。

5. **输出**：整合为 `serde_json`；Hub 与 Channel 均定义各自的 Output struct，方便 `serde_json::to_value`。

---

#### 4. 示例输出

Hub：
```json
{
  "hub_id": "0x…",
  "owner": "0x…",
  "balances": [
    { "coin_type": "0x3::gas_coin::RGas", "amount": "100000000" },
    { "coin_type": "0x3::USDC", "amount": "25000000" }
  ],
  "active_channels": [
    { "coin_type": "0x3::gas_coin::RGas", "count": 2 }
  ]
}
```

Channel：
```json
{
  "channel_id": "0x…",
  "sender": "0x…",
  "receiver": "0x…",
  "coin_type": "0x3::gas_coin::RGas",
  "status": "Active",
  "cancellation_info": null,
  "sub_channels_count": 3,
  "sub_channels": [
    { "fragment": "key-1", "pk_multibase": "z...", "method_type": "Ed25519", "last_amount": "10000", "last_nonce": 3 }
  ]
}
```

---

#### 5. 依赖与测试

* 无额外链上改动。
* 仅需确保 `rooch-rpc-server` 暴露的 `listFieldStates` 支持 Object + Table Handle（二者都是 ObjectID）。
* 新增 Rust integration test：开本地节点 → 建立简单 hub / channel → 调用 CLI → 比对 JSON snapshot。

---

> **下一步**：
> 1. 更新 `crates/rooch/src/commands/payment_channel/commands/query.rs` 按此命令结构重写（当前 placeholder 实现需改动）。
> 2. 如有缺失的 RPC helper（例如直接通过 Move view 取 `get_payment_hub_id`），补充 Rust module binding。
