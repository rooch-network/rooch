name: GC Long-term Integration Test

on:
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'Stress test duration (seconds)'
        required: false
        default: '3600'
        type: choice
        options:
          - '300'    # 5 minutes
          - '1800'   # 30 minutes
          - '3600'   # 1 hour
          - '7200'   # 2 hours
          - '14400'  # 4 hours
          - '28800'  # 8 hours
      target_tps:
        description: 'Target transactions per second'
        required: false
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '20'
          - '50'
      operation_mix:
        description: 'Operation mix ratio preset'
        required: false
        default: 'balanced'
        type: choice
        options:
          - 'balanced'      # 40% create, 30% update, 20% delete, 10% counter
          - 'create-heavy'  # 60% create, 20% update, 10% delete, 10% counter
          - 'delete-heavy'  # 20% create, 30% update, 40% delete, 10% counter
          - 'mixed'         # 25% each
      enable_disk_monitoring:
        description: 'Enable real disk usage monitoring'
        required: false
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

jobs:
  gc-long-term-test:
    name: GC Long-term Test
    runs-on: self-hosted
    timeout-minutes: 720 # 12 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'gc-test'
          cache-on-failure: true

      - name: Build Rooch binary (optci profile)
        run: |
          echo "Building Rooch binary with optci profile..."
          cargo build --profile optci --bin rooch
          ls -lh target/optci/rooch

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20.3.1'

      - name: Setup pnpm
        run: |
          npm install pnpm@9.10.0 -g
          pnpm install

      - name: Build test dependencies
        run: |
          pnpm --filter @roochnetwork/test-suite build
          pnpm --filter @roochnetwork/rooch-pruner-e2e exec vitest --version

      - name: Setup test data directory
        id: disk-setup
        run: |
          # Create dedicated base directory for test data
          TEST_BASE_DIR="/tmp/rooch_gc_test_$(date +%s)"
          mkdir -p "$TEST_BASE_DIR"
          echo "test_base_dir=$TEST_BASE_DIR" >> $GITHUB_OUTPUT
          echo "Test data base directory: $TEST_BASE_DIR"

          # Start disk monitoring if enabled
          if [ "${{ inputs.enable_disk_monitoring }}" = "true" ]; then
            MONITOR_SCRIPT="${{ github.workspace }}/scripts/monitor_disk_usage.sh"
            if [ ! -f "$MONITOR_SCRIPT" ]; then
              echo "ERROR: Monitoring script not found at $MONITOR_SCRIPT" >&2
              exit 1
            fi

            chmod +x "$MONITOR_SCRIPT"

            # Start monitoring in background
            "$MONITOR_SCRIPT" "$TEST_BASE_DIR" "/tmp/disk_usage.log" &
            MONITOR_PID=$!
            echo "monitor_pid=$MONITOR_PID" >> $GITHUB_OUTPUT
            echo "Started disk monitor (PID: $MONITOR_PID) for base directory: $TEST_BASE_DIR"
          else
            echo "Disk monitoring disabled"
          fi

      - name: Determine operation mix ratios
        id: mix-ratios
        run: |
          case "${{ inputs.operation_mix }}" in
            balanced)
              echo "create=0.4" >> $GITHUB_OUTPUT
              echo "update=0.3" >> $GITHUB_OUTPUT
              echo "delete=0.2" >> $GITHUB_OUTPUT
              echo "counter=0.1" >> $GITHUB_OUTPUT
              ;;
            create-heavy)
              echo "create=0.6" >> $GITHUB_OUTPUT
              echo "update=0.2" >> $GITHUB_OUTPUT
              echo "delete=0.1" >> $GITHUB_OUTPUT
              echo "counter=0.1" >> $GITHUB_OUTPUT
              ;;
            delete-heavy)
              echo "create=0.2" >> $GITHUB_OUTPUT
              echo "update=0.3" >> $GITHUB_OUTPUT
              echo "delete=0.4" >> $GITHUB_OUTPUT
              echo "counter=0.1" >> $GITHUB_OUTPUT
              ;;
            mixed)
              echo "create=0.25" >> $GITHUB_OUTPUT
              echo "update=0.25" >> $GITHUB_OUTPUT
              echo "delete=0.25" >> $GITHUB_OUTPUT
              echo "counter=0.25" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Run GC stress test
        id: gc-test
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci
          TESTBOX_BASE_DIR: ${{ steps.disk-setup.outputs.test_base_dir }}
          TESTBOX_KEEP_TMP: 'true'
          # GC Stress test configuration
          GC_STRESS_MODE: 'true'
          GC_STRESS_DURATION: ${{ inputs.test_duration }}
          GC_STRESS_TPS: ${{ inputs.target_tps }}
          GC_STRESS_BATCH_SIZE: '10'
          GC_STRESS_REPORT_INTERVAL: '60'
          # Operation mix ratios
          GC_STRESS_MIX_CREATE: ${{ steps.mix-ratios.outputs.create }}
          GC_STRESS_MIX_UPDATE: ${{ steps.mix-ratios.outputs.update }}
          GC_STRESS_MIX_DELETE: ${{ steps.mix-ratios.outputs.delete }}
          GC_STRESS_MIX_COUNTER: ${{ steps.mix-ratios.outputs.counter }}
        run: |
          echo "Starting GC long-term stress test..."
          echo "=========================================="
          echo "Environment Variables Check:"
          echo "  GC_STRESS_MODE=$GC_STRESS_MODE"
          echo "  GC_STRESS_DURATION=$GC_STRESS_DURATION"
          echo "  GC_STRESS_TPS=$GC_STRESS_TPS"
          echo "  GC_STRESS_BATCH_SIZE=$GC_STRESS_BATCH_SIZE"
          echo "  GC_STRESS_REPORT_INTERVAL=$GC_STRESS_REPORT_INTERVAL"
          echo "  Operation Mix:"
          echo "    - Create: $GC_STRESS_MIX_CREATE"
          echo "    - Update: $GC_STRESS_MIX_UPDATE"
          echo "    - Delete: $GC_STRESS_MIX_DELETE"
          echo "    - Counter: $GC_STRESS_MIX_COUNTER"
          echo "  TESTBOX_BASE_DIR=$TESTBOX_BASE_DIR"
          echo "  TESTBOX_KEEP_TMP=$TESTBOX_KEEP_TMP"
          echo "=========================================="
          
          # Calculate expected time
          EXPECTED_TXNS=$((GC_STRESS_DURATION * GC_STRESS_TPS))
          EXPECTED_TIME_MIN=$((GC_STRESS_DURATION / 60 + 20))  # +20min for setup and GC
          echo "Expected transactions: approximately $EXPECTED_TXNS"
          echo "Expected total time: approximately $EXPECTED_TIME_MIN minutes"
          echo "=========================================="

          # Record start time
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT

          # Run the test
          cd sdk/typescript/rooch-pruner-e2e
          
          set +e
          pnpm test:gc:stress:custom 2>&1 | tee gc-test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Record end time
          END_TIME=$(date +%s)
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Summary
          echo "=========================================="
          echo "Test completed in $DURATION seconds ($((DURATION / 60)) minutes)"
          echo "Test exit code: $TEST_EXIT_CODE"
          echo "=========================================="
          
          # Exit with test exit code
          exit $TEST_EXIT_CODE

      - name: Extract GC metrics from test output
        id: gc-metrics
        if: always()
        run: |
          # Extract GC report metrics from test output
          cd sdk/typescript/rooch-pruner-e2e
          
          if [ -f gc-test-output.log ]; then
            # Extract metrics from the GC Report section
            NODES_MARKED=$(grep -oP 'Nodes Marked: \K\d+' gc-test-output.log | tail -1 || echo "0")
            NODES_DELETED=$(grep -oP 'Deleted: \K\d+' gc-test-output.log | tail -1 || echo "0")
            RECYCLE_BIN_ENTRIES=$(grep -oP 'Recycle Bin Entries: \K\d+' gc-test-output.log | tail -1 || echo "0")
            SPACE_RECLAIMED=$(grep -oP 'Space Reclaimed: \K[\d.]+' gc-test-output.log | tail -1 || echo "0")
            GC_DURATION=$(grep -oP 'Total Duration: \K\d+' gc-test-output.log | tail -1 || echo "0")
            
            # Extract transaction statistics
            TOTAL_TXS=$(grep -oP 'Total Transactions: \K\d+' gc-test-output.log | tail -1 || echo "0")
            ACTUAL_TPS=$(grep -oP 'Actual TPS: \K[\d.]+' gc-test-output.log | tail -1 || echo "0")
            CREATED=$(grep -oP 'Create: \K\d+' gc-test-output.log | tail -1 || echo "0")
            UPDATED=$(grep -oP 'Update: \K\d+' gc-test-output.log | tail -1 || echo "0")
            DELETED=$(grep -oP 'Delete: \K\d+' gc-test-output.log | tail -1 || echo "0")
            COUNTER_OPS=$(grep -oP 'Counter: \K\d+' gc-test-output.log | tail -1 || echo "0")
            
            echo "nodes_marked=$NODES_MARKED" >> $GITHUB_OUTPUT
            echo "nodes_deleted=$NODES_DELETED" >> $GITHUB_OUTPUT
            echo "recycle_bin_entries=$RECYCLE_BIN_ENTRIES" >> $GITHUB_OUTPUT
            echo "space_reclaimed=$SPACE_RECLAIMED" >> $GITHUB_OUTPUT
            echo "gc_duration=$GC_DURATION" >> $GITHUB_OUTPUT
            echo "total_txs=$TOTAL_TXS" >> $GITHUB_OUTPUT
            echo "actual_tps=$ACTUAL_TPS" >> $GITHUB_OUTPUT
            echo "created=$CREATED" >> $GITHUB_OUTPUT
            echo "updated=$UPDATED" >> $GITHUB_OUTPUT
            echo "deleted=$DELETED" >> $GITHUB_OUTPUT
            echo "counter_ops=$COUNTER_OPS" >> $GITHUB_OUTPUT
            
            echo "Extracted GC metrics from test output"
          else
            echo "Test output log not found, using default values"
            echo "nodes_marked=0" >> $GITHUB_OUTPUT
            echo "nodes_deleted=0" >> $GITHUB_OUTPUT
            echo "recycle_bin_entries=0" >> $GITHUB_OUTPUT
            echo "space_reclaimed=0" >> $GITHUB_OUTPUT
            echo "gc_duration=0" >> $GITHUB_OUTPUT
            echo "total_txs=0" >> $GITHUB_OUTPUT
            echo "actual_tps=0" >> $GITHUB_OUTPUT
            echo "created=0" >> $GITHUB_OUTPUT
            echo "updated=0" >> $GITHUB_OUTPUT
            echo "deleted=0" >> $GITHUB_OUTPUT
            echo "counter_ops=0" >> $GITHUB_OUTPUT
          fi

      - name: Analyze disk usage
        id: disk-analysis
        if: ${{ inputs.enable_disk_monitoring && always() }}
        run: |
          # Stop monitoring
          if [ -n "${{ steps.disk-setup.outputs.monitor_pid }}" ]; then
            kill ${{ steps.disk-setup.outputs.monitor_pid }} 2>/dev/null || true
          fi

          # Analyze disk usage
          if [ -f /tmp/disk_usage.log ]; then
            PEAK_USAGE=$(awk -F',' '{print $3}' /tmp/disk_usage.log | sort -n | tail -1)
            echo "peak_usage=$PEAK_USAGE" >> $GITHUB_OUTPUT
            
            TEST_BASE_DIR="${{ steps.disk-setup.outputs.test_base_dir }}"
            FINAL_USAGE=0
            if [ -d "$TEST_BASE_DIR" ]; then
              while IFS= read -r dir; do
                if [[ "$dir" == */.rooch_test ]] && [ -d "${dir}/data" ]; then
                  continue
                fi
                if [ -d "$dir" ]; then
                  DIR_SIZE=$(du -sb "$dir" 2>/dev/null | awk '{print $1}')
                  if [ -n "$DIR_SIZE" ] && [ "$DIR_SIZE" -gt 0 ] 2>/dev/null; then
                    FINAL_USAGE=$((FINAL_USAGE + DIR_SIZE))
                  fi
                fi
              done < <(find "$TEST_BASE_DIR" -type d \( -path "*/testbox-*/.rooch_test/data" -o -path "*/testbox-*/.rooch_test" \) 2>/dev/null)
              echo "final_usage=$FINAL_USAGE" >> $GITHUB_OUTPUT
              
              if [ -n "$PEAK_USAGE" ] && [ "$PEAK_USAGE" -gt 0 ] && [ -n "$FINAL_USAGE" ]; then
                RECLAIMED=$((PEAK_USAGE - FINAL_USAGE))
                echo "reclaimed=$RECLAIMED" >> $GITHUB_OUTPUT
                
                echo "Peak disk usage: $PEAK_USAGE bytes"
                echo "Final disk usage: $FINAL_USAGE bytes"
                echo "Space reclaimed by GC: $RECLAIMED bytes"
                
                if [ $PEAK_USAGE -gt 0 ]; then
                  RECLAIM_PCT=$(awk "BEGIN {printf \"%.2f\", $RECLAIMED * 100 / $PEAK_USAGE}")
                  echo "reclaim_percentage=$RECLAIM_PCT" >> $GITHUB_OUTPUT
                  echo "Reclaim percentage: $RECLAIM_PCT%"
                fi
              fi
            fi
            
            cp /tmp/disk_usage.log disk-usage-timeline.csv
          else
            echo "Disk monitoring log not found"
          fi

      - name: Generate test report
        if: always()
        run: |
          # Pre-calculate all values
          START_TIME="${{ steps.gc-test.outputs.start_time }}"
          END_TIME="${{ steps.gc-test.outputs.end_time }}"
          DURATION="${{ steps.gc-test.outputs.duration }}"
          
          # Format timestamps
          if [ -n "$START_TIME" ] && [ "$START_TIME" != "" ]; then
            START_TIME_FMT=$(date -d "@$START_TIME" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date -r "$START_TIME" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "N/A")
          else
            START_TIME_FMT="N/A"
          fi
          
          if [ -n "$END_TIME" ] && [ "$END_TIME" != "" ]; then
            END_TIME_FMT=$(date -d "@$END_TIME" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date -r "$END_TIME" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "N/A")
          else
            END_TIME_FMT="N/A"
          fi
          
          # Format duration
          if [ -n "$DURATION" ] && [ "$DURATION" -gt 0 ] 2>/dev/null; then
            DURATION_MIN=$((DURATION / 60))
            DURATION_SEC=$((DURATION % 60))
            DURATION_FMT="${DURATION_MIN}m ${DURATION_SEC}s ($DURATION seconds)"
          else
            DURATION_FMT="N/A"
          fi
          
          # Calculate GC duration in human readable form
          GC_DURATION_MS="${{ steps.gc-metrics.outputs.gc_duration }}"
          if [ -n "$GC_DURATION_MS" ] && [ "$GC_DURATION_MS" -gt 0 ] 2>/dev/null; then
            GC_DURATION_SEC=$((GC_DURATION_MS / 1000))
            GC_DURATION_FMT="${GC_DURATION_SEC}s (${GC_DURATION_MS}ms)"
          else
            GC_DURATION_FMT="N/A"
          fi
          
          # Calculate disk values in MB
          PEAK_USAGE="${{ steps.disk-analysis.outputs.peak_usage }}"
          FINAL_USAGE="${{ steps.disk-analysis.outputs.final_usage }}"
          RECLAIMED="${{ steps.disk-analysis.outputs.reclaimed }}"
          
          PEAK_USAGE_MB=$(awk "BEGIN {printf \"%.2f\", ${PEAK_USAGE:-0} / 1024 / 1024}" 2>/dev/null || echo "N/A")
          FINAL_USAGE_MB=$(awk "BEGIN {printf \"%.2f\", ${FINAL_USAGE:-0} / 1024 / 1024}" 2>/dev/null || echo "N/A")
          RECLAIMED_MB=$(awk "BEGIN {printf \"%.2f\", ${RECLAIMED:-0} / 1024 / 1024}" 2>/dev/null || echo "N/A")
          
          # Generate report
          cat > test-report.md << 'REPORT_EOF'
          # GC Long-term Stress Test Report

          ## Test Configuration

          - **Test Duration**: ${{ inputs.test_duration }} seconds (${{ inputs.test_duration | 60 }} minutes)
          - **Target TPS**: ${{ inputs.target_tps }}
          - **Operation Mix**: ${{ inputs.operation_mix }}
          - **Start Time**: ${START_TIME_FMT}
          - **End Time**: ${END_TIME_FMT}
          - **Actual Duration**: ${DURATION_FMT}

          ## Operation Mix Ratios

          - **Create Operations**: ${{ steps.mix-ratios.outputs.create }} (${{ steps.gc-metrics.outputs.created }} executed)
          - **Update Operations**: ${{ steps.mix-ratios.outputs.update }} (${{ steps.gc-metrics.outputs.updated }} executed)
          - **Delete Operations**: ${{ steps.mix-ratios.outputs.delete }} (${{ steps.gc-metrics.outputs.deleted }} executed)
          - **Counter Operations**: ${{ steps.mix-ratios.outputs.counter }} (${{ steps.gc-metrics.outputs.counter_ops }} executed)

          ## Workload Statistics

          - **Total Transactions**: ${{ steps.gc-metrics.outputs.total_txs }}
          - **Actual TPS**: ${{ steps.gc-metrics.outputs.actual_tps }}
          - **Expected Transactions**: $((inputs.test_duration * inputs.target_tps))

          ## GC Performance Metrics

          ### Node Processing
          - **Nodes Marked**: ${{ steps.gc-metrics.outputs.nodes_marked }}
          - **Nodes Deleted**: ${{ steps.gc-metrics.outputs.nodes_deleted }}
          - **Recycle Bin Entries**: ${{ steps.gc-metrics.outputs.recycle_bin_entries }}

          ### Efficiency
          - **Space Reclaimed**: ${{ steps.gc-metrics.outputs.space_reclaimed }}%
          - **GC Duration**: ${GC_DURATION_FMT}
          REPORT_EOF

          # Add disk monitoring results if available
          if [ "${{ inputs.enable_disk_monitoring }}" = "true" ]; then
            cat >> test-report.md << 'DISK_EOF'

          ## Real Disk Usage Analysis

          > **Note**: Disk usage monitoring measures the effectiveness of GC in reclaiming space.
          > The test generates data continuously while GC runs in the background.

          - **Peak Usage**: ${PEAK_USAGE_MB} MB
          - **Final Usage**: ${FINAL_USAGE_MB} MB
          - **Space Reclaimed**: ${RECLAIMED_MB} MB
          - **Reclaim Percentage**: ${{ steps.disk-analysis.outputs.reclaim_percentage }}%

          DISK_EOF
          fi

          cat >> test-report.md << 'SUMMARY_EOF'

          ## Test Outcome

          - **Exit Code**: ${{ steps.gc-test.outputs.test_exit_code }}
          - **Status**: ${{ steps.gc-test.outputs.test_exit_code == 0 && '✅ PASSED' || '❌ FAILED' }}

          ## Artifacts

          - Full test logs: `gc-test-output.log`
          - Disk usage timeline: `disk-usage-timeline.csv` (if monitoring enabled)
          - Test data directory: Available as separate artifact

          SUMMARY_EOF

          # Substitute variables in the report
          sed -i "s/\${START_TIME_FMT}/$START_TIME_FMT/g" test-report.md
          sed -i "s/\${END_TIME_FMT}/$END_TIME_FMT/g" test-report.md
          sed -i "s/\${DURATION_FMT}/$DURATION_FMT/g" test-report.md
          sed -i "s/\${GC_DURATION_FMT}/$GC_DURATION_FMT/g" test-report.md
          sed -i "s/\${PEAK_USAGE_MB}/$PEAK_USAGE_MB/g" test-report.md
          sed -i "s/\${FINAL_USAGE_MB}/$FINAL_USAGE_MB/g" test-report.md
          sed -i "s/\${RECLAIMED_MB}/$RECLAIMED_MB/g" test-report.md

          cat test-report.md
          echo "Test report generated"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gc-test-report-${{ github.run_number }}
          path: |
            sdk/typescript/rooch-pruner-e2e/gc-test-output.log
            test-report.md
            disk-usage-timeline.csv
          retention-days: 30

      - name: Create test data manifest
        if: always()
        run: |
          TEST_BASE_DIR="${{ steps.disk-setup.outputs.test_base_dir }}"
          if [ -n "$TEST_BASE_DIR" ] && [ -d "$TEST_BASE_DIR" ]; then
            cat > "$TEST_BASE_DIR/test-manifest.txt" << MANIFEST_EOF
          Test Run Information:
          ===================
          GitHub Run ID: ${{ github.run_number }}
          Workflow: ${{ github.workflow }}
          Repository: ${{ github.repository }}
          Commit: ${{ github.sha }}

          Test Configuration:
          - Test Duration: ${{ inputs.test_duration }} seconds
          - Target TPS: ${{ inputs.target_tps }}
          - Operation Mix: ${{ inputs.operation_mix }}
          - Disk Monitoring: ${{ inputs.enable_disk_monitoring }}
          - Start Time: ${{ steps.gc-test.outputs.start_time }}
          - End Time: ${{ steps.gc-test.outputs.end_time }}
          - Duration: ${{ steps.gc-test.outputs.duration }} seconds
          - Exit Code: ${{ steps.gc-test.outputs.test_exit_code }}

          GC Metrics:
          - Nodes Marked: ${{ steps.gc-metrics.outputs.nodes_marked }}
          - Nodes Deleted: ${{ steps.gc-metrics.outputs.nodes_deleted }}
          - Recycle Bin Entries: ${{ steps.gc-metrics.outputs.recycle_bin_entries }}
          - Space Reclaimed: ${{ steps.gc-metrics.outputs.space_reclaimed }}%

          Workload Statistics:
          - Total Transactions: ${{ steps.gc-metrics.outputs.total_txs }}
          - Actual TPS: ${{ steps.gc-metrics.outputs.actual_tps }}
          - Created: ${{ steps.gc-metrics.outputs.created }}
          - Updated: ${{ steps.gc-metrics.outputs.updated }}
          - Deleted: ${{ steps.gc-metrics.outputs.deleted }}
          - Counter Ops: ${{ steps.gc-metrics.outputs.counter_ops }}

          Total Files: $(find "$TEST_BASE_DIR" -type f 2>/dev/null | wc -l 2>/dev/null || echo "0")
          Total Size: $(du -sh "$TEST_BASE_DIR" 2>/dev/null | awk '{print $1}' 2>/dev/null || echo "Unknown")
          MANIFEST_EOF
          fi

      - name: Upload test data directory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gc-test-data-${{ github.run_number }}
          path: ${{ steps.disk-setup.outputs.test_base_dir }}
          retention-days: 7
          if-no-files-found: warn

      - name: Post report summary
        if: always()
        run: |
          if [ -f test-report.md ]; then
            cat test-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup test environment
        if: always()
        run: |
          # Kill any remaining rooch processes
          pkill -f "rooch server" || true

          # Stop disk monitor if still running
          if [ -n "${{ steps.disk-setup.outputs.monitor_pid }}" ]; then
            kill ${{ steps.disk-setup.outputs.monitor_pid }} 2>/dev/null || true
          fi

          # Clean up test data directory
          if [ -n "${{ steps.disk-setup.outputs.test_base_dir }}" ]; then
            echo "Cleaning up test data directory: ${{ steps.disk-setup.outputs.test_base_dir }}"
            rm -rf "${{ steps.disk-setup.outputs.test_base_dir }}" || true
          fi

          # Clean up monitoring files
          rm -f /tmp/disk_usage.log

