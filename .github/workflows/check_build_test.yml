name: Check-Build-Test

on:
  push:
    branches: ['main']
    paths-ignore:
      - 'docs/**'
      - 'fixtures/**'
      - 'kube/**'
      - '**.md'
      - 'crates/rooch-anomalies/static/**'
  pull_request:
    branches: ['main']
    paths-ignore:
      - 'docs/**'
      - 'fixtures/**'
      - 'kube/**'
      - '**.md'
      - 'crates/rooch-anomalies/static/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  ENV_TEST_ON_CI: 1
  CARGO_INCREMENTAL: 0

jobs:
  # Phase 1: Check changes
  check_changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.changes.outputs.core }}
      sdk_web: ${{ steps.changes.outputs.sdk_web }}
      is_dependabot: ${{ steps.check_dependabot.outputs.is_dependabot }}
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dependabot PR
        id: check_dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "ðŸ¤– This is a Dependabot PR - will run reduced test suite"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
            echo "ðŸ‘¤ This is a regular PR - will run full test suite"
          fi

      - name: Filter Changed Files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            core:
              - '.cargo/**'
              - '.github/workflows/check_build_test.yml'
              - 'crates/**'
              - 'moveos/**'
              - 'frameworks/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'rust-toolchain.toml'
              - 'apps/**'
              - 'examples/**'
              - 'generator/**'
              - 'third-party/**'
            sdk_web:
              - 'infra/**'
              - 'sdk/**'
              - '.eslintrc.js'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'prettier.config.js'

  # Phase 2: Build and verify (larger-runner)
  build_and_verify:
    name: Build and Verify
    runs-on: larger-runner
    needs: check_changes
    if: ${{ needs.check_changes.outputs.core == 'true' || needs.check_changes.outputs.sdk_web == 'true' }}
    timeout-minutes: 75
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ci'
          cache-on-failure: true

      - name: Install cargo tools
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          make install-tools

      - name: Build Rust binaries (optci profile)
        run: |
          echo "Building binaries with 16 parallel jobs..."
          cargo build --profile optci --workspace --bins -j 16

      - name: Rooch init
        run: |
          ./target/optci/framework-release
          ./target/optci/rooch init --skip-password

      - name: Generate genesis files
        run: make generate-genesis
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

      - name: Check git status
        uses: CatChen/check-git-status-action@v1
        with:
          fail-if-not-clean: true
          push-if-not-clean: false
          targets: '.'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rooch-binaries
          path: |
            target/optci/rooch
            target/optci/rooch-genesis
            target/optci/framework-release
          retention-days: 1

  # Phase 3: Rust tests (compile and run on ubuntu-latest with cache)
  test_rust_unit:
    name: Rust Unit Tests
    runs-on: ubuntu-latest
    needs: build_and_verify
    if: ${{ needs.check_changes.outputs.core == 'true' }}
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ci'
          cache-on-failure: true

      - name: Install cargo tools
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          make install-tools

      - name: Install cargo-nextest
        run: |
          echo "Installing cargo-nextest from GitHub releases..."
          curl -LsSf https://github.com/nextest-rs/nextest/releases/download/cargo-nextest-0.9.97/cargo-nextest-0.9.97-x86_64-unknown-linux-gnu.tar.gz | tar xz -C ~/.cargo/bin
          cargo nextest --version

      - name: Run Rust unit tests
        run: |
          echo "Running unit tests (will compile with cache)..."
          make test-rust-unit
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  test_rust_framework:
    name: Rust Framework Tests
    runs-on: ubuntu-latest
    needs: build_and_verify
    if: ${{ needs.check_changes.outputs.core == 'true' }}
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ci'
          cache-on-failure: true

      - name: Install cargo tools
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          make install-tools

      - name: Install cargo-nextest
        run: |
          echo "Installing cargo-nextest from GitHub releases..."
          curl -LsSf https://github.com/nextest-rs/nextest/releases/download/cargo-nextest-0.9.97/cargo-nextest-0.9.97-x86_64-unknown-linux-gnu.tar.gz | tar xz -C ~/.cargo/bin
          cargo nextest --version

      - name: Run Rust framework tests
        run: |
          echo "Running framework tests (will compile with cache)..."
          make test-rust-framework
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  test_rust_bitcoin:
    name: Rust Bitcoin Tests
    runs-on: ubuntu-latest
    needs: build_and_verify
    if: ${{ needs.check_changes.outputs.core == 'true' }}
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ci'
          cache-on-failure: true

      - name: Install cargo tools
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          make install-tools

      - name: Install cargo-nextest
        run: |
          echo "Installing cargo-nextest from GitHub releases..."
          curl -LsSf https://github.com/nextest-rs/nextest/releases/download/cargo-nextest-0.9.97/cargo-nextest-0.9.97-x86_64-unknown-linux-gnu.tar.gz | tar xz -C ~/.cargo/bin
          cargo nextest --version

      - name: Run Rust Bitcoin tests
        run: |
          echo "Running Bitcoin tests (will compile with cache)..."
          make test-rust-bitcoin
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  test_rust_integration_suite:
    name: Rust Integration Suite Tests
    runs-on: ubuntu-latest
    needs: build_and_verify
    if: ${{ needs.check_changes.outputs.core == 'true' && needs.check_changes.outputs.is_dependabot != 'true' }}
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ci'
          cache-on-failure: true

      - name: Install cargo tools
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          make install-tools

      - name: Install cargo-nextest
        run: |
          echo "Installing cargo-nextest from GitHub releases..."
          curl -LsSf https://github.com/nextest-rs/nextest/releases/download/cargo-nextest-0.9.97/cargo-nextest-0.9.97-x86_64-unknown-linux-gnu.tar.gz | tar xz -C ~/.cargo/bin
          cargo nextest --version

      - name: Run Rust integration suite tests
        run: |
          echo "Running integration suite tests (will compile with cache)..."
          make test-rust-integration-suite
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  lint:
    name: Rust Lint
    runs-on: larger-runner
    needs: build_and_verify
    if: ${{ needs.check_changes.outputs.core == 'true' }}
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ci'
          cache-on-failure: true

      - name: Install cargo tools
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          make install-tools

      - name: Run Rust Lint
        run: |
          echo "Running lint on larger-runner (compiles workspace for analysis)..."
          make lint
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  test_move_frameworks:
    name: Move Framework Tests
    runs-on: ubuntu-latest
    needs: [check_changes, build_and_verify]
    if: ${{ needs.check_changes.outputs.core == 'true' && needs.check_changes.outputs.is_dependabot != 'true' }}
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: rooch-binaries
          path: target/optci

      - name: Make binaries executable
        run: |
          chmod +x target/optci/rooch
          chmod +x target/optci/rooch-genesis
          chmod +x target/optci/framework-release

      - name: Rooch init
        run: |
          ./target/optci/framework-release
          ./target/optci/rooch init --skip-password

      - name: Run Move tests
        run: |
          echo "ROOCH_BINARY_BUILD_PROFILE is set to: $ROOCH_BINARY_BUILD_PROFILE"
          echo "Expected rooch binary at: target/$ROOCH_BINARY_BUILD_PROFILE/rooch"
          ls -la target/$ROOCH_BINARY_BUILD_PROFILE/rooch || echo "Binary not found!"
          make test-move
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  test_move_examples:
    name: Move Examples Tests
    runs-on: ubuntu-latest
    needs: [check_changes, build_and_verify]
    if: ${{ needs.check_changes.outputs.core == 'true' && needs.check_changes.outputs.is_dependabot != 'true' }}
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: rooch-binaries
          path: target/optci

      - name: Make binaries executable
        run: |
          chmod +x target/optci/rooch
          chmod +x target/optci/rooch-genesis
          chmod +x target/optci/framework-release

      - name: Rooch init
        run: |
          ./target/optci/framework-release
          ./target/optci/rooch init --skip-password

      - name: Run Move examples tests
        run: make test-move-examples
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci

  test_sdk_web:
    name: SDK and Web Tests
    runs-on: ubuntu-latest
    needs: [check_changes, build_and_verify]
    if: ${{ (needs.check_changes.outputs.core == 'true' || needs.check_changes.outputs.sdk_web == 'true') && needs.check_changes.outputs.is_dependabot != 'true' }}
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: rooch-binaries
          path: target/optci

      - name: Make binaries executable
        run: |
          chmod +x target/optci/rooch
          chmod +x target/optci/rooch-genesis
          chmod +x target/optci/framework-release

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20.3.1'

      - name: Setup pnpm Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Run SDK and Web tests
        env:
          ROOCH_BINARY_BUILD_PROFILE: optci
        run: |
          docker --version
          if ! docker images | grep -q 'lncm/bitcoind.*v25.1'; then
            echo "Pulling Docker image..."
            docker pull lncm/bitcoind:v25.1
          else
            echo "Using cached Docker image"
          fi

          npm install pnpm@9.10.0 -g
          pnpm install

          echo "Building in parallel..."
          pnpm rooch-sdk lint

          pnpm test-suite build &
          PID_TEST_SUITE=$!
          pnpm rooch-sdk build &
          PID_SDK=$!
          pnpm rooch-sdk-kit build &
          PID_SDK_KIT=$!

          EXIT_CODE_LINT=$?
          wait $PID_TEST_SUITE
          EXIT_CODE_TEST_SUITE=$?
          wait $PID_SDK
          EXIT_CODE_SDK=$?
          wait $PID_SDK_KIT
          EXIT_CODE_SDK_KIT=$?

          if [ $EXIT_CODE_LINT -ne 0 ]; then
            echo "Error: The linting failed."
            exit $EXIT_CODE_LINT
          fi
          if [ $EXIT_CODE_TEST_SUITE -ne 0 ]; then
            echo "Error: The test suite build failed."
            exit $EXIT_CODE_TEST_SUITE
          fi
          if [ $EXIT_CODE_SDK -ne 0 ]; then
            echo "Error: The SDK build failed."
            exit $EXIT_CODE_SDK
          fi
          if [ $EXIT_CODE_SDK_KIT -ne 0 ]; then
            echo "Error: The SDK kit build failed."
            exit $EXIT_CODE_SDK_KIT
          fi

          echo "Web and SDK tests passed."
          echo "Running tests..."
          pnpm rooch-sdk test
          pnpm rooch-sdk-kit test || true
